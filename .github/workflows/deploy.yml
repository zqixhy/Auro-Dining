- name: Deploy on EC2 (Docker)
    env:
      RDS_ENDPOINT: ${{ secrets.RDS_ENDPOINT }}
      DB_USERNAME: ${{ secrets.DB_USERNAME }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      FORCE_REBUILD: ${{ inputs.force_rebuild }}
    run: |
      ssh -i ~/.ssh/deploy_key ${EC2_USERNAME:-ec2-user}@$EC2_HOST << 'DEPLOY_SCRIPT'
        set -e
        set -x
      
        # Ensure /usr/local/bin is in PATH for all sudo commands
        export PATH=$PATH:/usr/local/bin
      
        echo "=== Starting deployment ==="
        cd ~/auro-dining || { echo "ERROR: Directory ~/auro-dining not found"; exit 1; }
      
        # Move deployment artifacts from 'incoming' to project root
        echo "=== Updating application files ==="
        mv -f incoming/auro-dining-0.0.1-SNAPSHOT.jar .
        mv -f incoming/application-aws.yml .
        mv -f incoming/Dockerfile .
        mv -f incoming/docker-compose.yml .
        # Cleanup staging folder
        rm -rf incoming
      
        # Use absolute path to bypass any shell detection issues
        DOCKER_COMPOSE_CMD="/usr/local/bin/docker-compose"
        echo "Using command: $DOCKER_COMPOSE_CMD"
      
        # Export database secrets for the Docker containers
        export RDS_ENDPOINT="${{ secrets.RDS_ENDPOINT }}"
        export DB_USERNAME="${{ secrets.DB_USERNAME }}"
        export DB_PASSWORD="${{ secrets.DB_PASSWORD }}"
      
        # Handle the Force Rebuild flag from GitHub UI
        BUILD_ARGS=""
        if [ "${{ inputs.force_rebuild }}" == "true" ]; then
          echo "Force rebuild triggered."
          BUILD_ARGS="--no-cache"
        fi
      
        # Execute the build and start the application
        echo "=== Building Docker image ==="
        sudo -E $DOCKER_COMPOSE_CMD build $BUILD_ARGS
      
        echo "=== Starting containers ==="
        sudo -E $DOCKER_COMPOSE_CMD up -d
      
        # Final health check of the local containers
        sudo $DOCKER_COMPOSE_CMD ps
      
        echo "=== Deployment completed successfully ==="
      DEPLOY_SCRIPT