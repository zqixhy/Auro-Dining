name: Aura Dining CI/CD

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      EC2_HOST: ${{ secrets.EC2_HOST }}
      EC2_USERNAME: ${{ secrets.EC2_USERNAME }}
      EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
      RDS_ENDPOINT: ${{ secrets.RDS_ENDPOINT }}
      DB_USERNAME: ${{ secrets.DB_USERNAME }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up JDK 11
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'corretto'
        cache: maven

    - name: Build with Maven
      run: mvn clean package -DskipTests

    - name: Prepare deployment package
      run: |
        mkdir -p deploy-package
        cp target/auro-dining-0.0.1-SNAPSHOT.jar deploy-package/
        cp src/main/resources/application-aws.yml deploy-package/
        cp Dockerfile deploy-package/
        cp deploy/docker-compose.yml deploy-package/
        cp deploy/install-docker.sh deploy-package/
        cp deploy/rollback-docker.sh deploy-package/

    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "$EC2_SSH_KEY" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts

    - name: Copy files to EC2
      run: |
        ssh -i ~/.ssh/deploy_key ${EC2_USERNAME:-ec2-user}@$EC2_HOST "mkdir -p ~/auro-dining/incoming"
        scp -i ~/.ssh/deploy_key \
          deploy-package/auro-dining-0.0.1-SNAPSHOT.jar \
          deploy-package/application-aws.yml \
          deploy-package/Dockerfile \
          deploy-package/docker-compose.yml \
          deploy-package/install-docker.sh \
          deploy-package/rollback-docker.sh \
          ${EC2_USERNAME:-ec2-user}@$EC2_HOST:~/auro-dining/incoming/

    - name: Deploy on EC2 (Docker)
      env:
        RDS_ENDPOINT: ${{ secrets.RDS_ENDPOINT }}
        DB_USERNAME: ${{ secrets.DB_USERNAME }}
        DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      run: |
        ssh -i ~/.ssh/deploy_key ${EC2_USERNAME:-ec2-user}@$EC2_HOST << 'DEPLOY_SCRIPT'
          set -e
          set -x  # Enable debug output
          
          echo "=== Starting deployment ==="
          cd ~/auro-dining || { echo "ERROR: Cannot cd to ~/auro-dining"; exit 1; }

          echo "=== Checking installation ==="
          if [ ! -f .installed ]; then
            echo "Running install script..."
            chmod +x incoming/install-docker.sh || { echo "ERROR: Cannot chmod install script"; exit 1; }
            ./incoming/install-docker.sh || { echo "ERROR: Install script failed"; exit 1; }
            touch .installed
          else
            echo "Already installed, skipping install script"
          fi

          echo "=== Backing up existing JAR ==="
          if [ -f auro-dining-0.0.1-SNAPSHOT.jar ]; then
            mkdir -p backups
            cp auro-dining-0.0.1-SNAPSHOT.jar "backups/auro-dining-$(date +%Y%m%d-%H%M%S).jar" || { echo "WARNING: Backup failed"; }
            ls -t backups/*.jar 2>/dev/null | tail -n +6 | xargs -r rm -f || true
          else
            echo "No existing JAR to backup"
          fi

          echo "=== Moving new files ==="
          mv -f incoming/auro-dining-0.0.1-SNAPSHOT.jar . || { echo "ERROR: Cannot move JAR file"; exit 1; }
          mv -f incoming/application-aws.yml . || { echo "ERROR: Cannot move application-aws.yml"; exit 1; }
          mv -f incoming/Dockerfile . || { echo "ERROR: Cannot move Dockerfile"; exit 1; }
          mv -f incoming/docker-compose.yml . || { echo "ERROR: Cannot move docker-compose.yml"; exit 1; }
          [ -f incoming/install-docker.sh ] && mv -f incoming/install-docker.sh . || true
          [ -f incoming/rollback-docker.sh ] && mv -f incoming/rollback-docker.sh . && chmod +x rollback-docker.sh || true
          rm -rf incoming

          echo "=== Setting environment variables ==="
          export RDS_ENDPOINT="$RDS_ENDPOINT"
          export DB_USERNAME="$DB_USERNAME"
          export DB_PASSWORD="$DB_PASSWORD"
          
          echo "=== Checking Docker ==="
          sudo docker --version || { echo "ERROR: Docker not found"; exit 1; }
          sudo docker compose version || { echo "ERROR: Docker Compose not found"; exit 1; }
          
          echo "=== Ensuring Docker Buildx is available ==="
          sudo docker buildx version || { echo "WARNING: Buildx not found, installing..."; sudo docker buildx install || true; }
          sudo docker buildx ls || true
          
          echo "=== Building Docker image ==="
          sudo -E docker compose build --no-cache || { echo "ERROR: Docker build failed"; exit 1; }
          
          echo "=== Starting containers ==="
          sudo -E docker compose up -d || { echo "ERROR: Docker compose up failed"; exit 1; }
          
          echo "=== Waiting for containers to start ==="
          sleep 5
          
          echo "=== Checking container status ==="
          sudo docker compose ps || { echo "ERROR: Cannot check container status"; exit 1; }
          
          echo "=== Deployment completed successfully ==="
        DEPLOY_SCRIPT

    - name: Verify deployment
      run: |
        sleep 15
        curl -sf "http://$EC2_HOST/" || echo "Warning: Application might not be ready yet"
